<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sign up</title>
    <!-- Bulma 自訂 -->
    <link rel="stylesheet" href="../asset/css/my-bulma.css" />
    <!-- 自定義 CSS -->
    <link rel="stylesheet" href="../asset/css/index-style.css" />
    <!-- Font Awesome -->
    <script
      src="https://kit.fontawesome.com/0548105e54.js"
      crossorigin="anonymous"
    ></script>
    <!-- jquery -->
    <script src="../asset/js/jquery-3.6.3.min.js"></script>
    <!-- 共用元件 -->
    <script
      defer
      src="../asset/js/components.js?ver=2"
      type="text/javascript"
    ></script>
    <!-- 初始化 Bulma -->
    <script defer src="../asset/js/bulma-init.js"></script>
  </head>
  <body>
    <header-component></header-component>
    <div class="columns">
      <div class="column"></div>
      <div class="column is-half">
        <section class="section">
          <!-- 標題 -->
          <div class="content has-text-centered"><h1>註冊</h1></div>
          <!-- 表單 -->
          <form class="box" action="#" method="post" id="form-signup">
            <div class="content msg"><p>請填寫以下欄位</p></div>
            <div class="field account">
              <p class="mt-1"></p>
              <label class="label" for="input-account">帳號</label>
              <div class="control has-icons-left">
                <input
                  class="input"
                  type="email"
                  name="account"
                  placeholder="alexyang@email.com"
                  id="input-account"
                />
                <span class="icon is-small is-left">
                  <i class="fas fa-envelope"></i>
                </span>
              </div>
            </div>

            <div class="field password">
              <p class="mt-1"></p>
              <label class="label" for="input-password">密碼</label>
              <div class="control has-icons-left">
                <input
                  class="input"
                  type="password"
                  name="password"
                  placeholder="********"
                  id="input-password"
                />
                <span class="icon is-small is-left">
                  <i class="fas fa-lock"></i>
                </span>
              </div>
            </div>

            <div class="field username">
              <p class="mt-1"></p>
              <label class="label" for="input-username">暱稱</label>
              <div class="control has-icons-left">
                <input
                  class="input"
                  type="text"
                  name="username"
                  placeholder="暱稱"
                  id="input-username"
                />
                <span class="icon is-small is-left">
                  <i class="fa-solid fa-user"></i>
                </span>
              </div>
            </div>

            <div class="field gender">
              <p class="mt-1"></p>
              <label class="label" for="input-gender">性別</label>
              <div class="control">
                <label><input type="radio" name="gender" value="男" />男</label>
                <label><input type="radio" name="gender" value="女" />女</label>
                <label
                  ><input type="radio" name="gender" value="其他" />其他</label
                >
              </div>
            </div>

            <div class="field birthday">
              <p class="mt-1"></p>
              <label class="label" for="input-birthday">生日</label>
              <div class="control">
                <input
                  class="input"
                  type="date"
                  name="birthday"
                  id="input-birthday"
                  min="1900-01-01"
                />
              </div>
            </div>

            <!-- 表單按鈕 -->
            <div class="field is-grouped">
              <div class="control">
                <button
                  class="button is-primary has-text-centered"
                  type="button"
                  id="btn-signup"
                >
                  註冊
                </button>
              </div>
              <div class="control">
                <button
                  class="button is-light has-text-centered"
                  type="button"
                  id="btn-back"
                >
                  回到首頁
                </button>
              </div>
            </div>
          </form>
        </section>
      </div>
      <div class="column"></div>
    </div>
    <footer-component></footer-component>
    <script src="../asset/js/checkLogin.js"></script>
    <script>
      $(function () {
        const account = $("input#input-account");
        const password = $("input#input-password");
        const username = $("input#input-username");
        const birth = document.querySelector("#input-birthday");

        birth.max = new Date(
          new Date().getTime() - new Date().getTimezoneOffset() * 60000
        )
          .toISOString()
          .split("T")[0];
        birth.value = new Date(
          new Date().getTime() - new Date().getTimezoneOffset() * 60000
        )
          .toISOString()
          .split("T")[0];
        $("button#btn-signup").on("click", function () {
          var gender = $("input[type=radio][name=gender]:checked");
          let error;
          let mail_regex = new RegExp(/^[^@\s]+@[^@\s]+\.[^@\s]+$/);
          // 6 ~ 16 字中英文組成，至少包含 1 個大寫英文與小寫英文，至少包含 1 個數字
          let ps_regex = new RegExp(/^(?=.*\d)(?=.*[a-z])(?=.*[A-Z]).{6,16}$/);

          error = false;
          $("div.field.account > p").empty();
          $("div.field.password > p").empty();
          $("div.field.username > p").empty();
          $("div.field.gender > p").empty();
          $("div.field.birthday > p").empty();
          if (!mail_regex.test(account.val().trim())) {
            let msg = `帳號須為電子信箱`;
            $("div.field.account > p").prepend(msg);
            $("div.field.account > p").css("color", "red");
            error = true;
          }
          if (!ps_regex.test(password.val().trim())) {
            let msg = `密碼需為 6 ~ 16 字中英文組成，至少包含 1 個大寫英文與小寫英文，至少包含 1 個數字`;
            $("div.field.password > p").prepend(msg);
            $("div.field.password > p").css("color", "red");
            error = true;
          }
          if (username.val().trim() == "") {
            let msg = `暱稱不能為空`;
            $("div.field.username > p").prepend(msg);
            $("div.field.username > p").css("color", "red");
            error = true;
          }
          if (gender.val() == null) {
            let msg = `性別不能為空`;
            $("div.field.gender > p").prepend(msg);
            $("div.field.gender > p").css("color", "red");
            error = true;
          }
          if (birth.value == null) {
            let msg = `生日不能為空`;
            $("div.field.birthday > p").prepend(msg);
            $("div.field.birthday > p").css("color", "red");
            error = true;
          }

          if (error) {
            $("html,body").animate({ scrollTop: 0 }, "fast");
          } else {
            fetch("register", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                account: account.val().trim(),
                password: password.val().trim(),
                username: username.val().trim(),
                gender: gender.val(),
                birthday: birth.value,
              }),
            }).then((resp) => {
              resp.json().then((body) => {
                if (body.successful == false) {
                  let msg = body.message;
                  $("div.msg").text(msg);
                  $("div.msg").css("color", "red");
                  $("html,body").animate({ scrollTop: 0 }, "fast");
                } else {
                  alert(
                    `successful: ${body.successful} message: ${body.message}`
                  );

                  location.href =
                    location.origin + "/lazy-trip-back/index.html";
                }
              });
            });
          }
        });
      });
    </script>
  </body>
</html>
