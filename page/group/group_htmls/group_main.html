<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>LazyTrip.io | 揪團</title>
    <!-- Bulma 自訂 -->
    <link rel="stylesheet" href="../../../asset/css/my-bulma.css" />
    <!-- 自定義 CSS -->
    <link rel="stylesheet" href="../../../asset/css/index-style.css" />
    <!-- Font Awesome -->
    <script
      src="https://kit.fontawesome.com/0548105e54.js"
      crossorigin="anonymous"
    ></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <!-- 共用元件 -->
    <script
      defer
      src="../../../asset/js/components.js"
      type="text/javascript"
    ></script>

    <!-- 初始化 Bulma -->
    <script defer src="../../../asset/js/bulma-init.js"></script>
    <!--GroupCss-->
    <link rel="stylesheet" href=".././css/group.css" />
  </head>
  <body>
    <!--預計加入:滑到內容若為登入者的留言要顯示刪除按鈕在右上角-->
    <!-- 導覽列 -->
    <header-component></header-component>
    <!--彈窗-->
    <div id="group_main_fs_alert">
      <div class="group_main_fs_alert_bg"></div>
      <div class="group_main_fs_alert_show">
        <div class="group_main_fs_alert_title">請輸入想找的朋友ID</div>
        <input
          class="input fs_alert_txt"
          id="fd_id"
          type="text"
          placeholder="請輸入ID"
        />
        <span class="icon" id="search_fd">
          <i class="fa-solid fas fa-lg fa-magnifying-glass"></i>
        </span>
        <div id="search_rs">沒有結果</div>
        <div class="btn_s button" id="alert_ok">OK</div>
      </div>
    </div>

    <!--揪團名-->
    <div class="column">
      <div class="content has-text-centered">
        <h1 id="gp_main_gpname"></h1>
      </div>
    </div>

    <!--資訊欄-->
    <div
      class="columns"
      style="border-bottom: 0.8px solid; border-color: #cfcff8"
    >
      <div class="column is-8"></div>
      <div class="column is-3 trip_info">
        <span>當前行程:</span>
        <span class="trip_name">暫無行程</span>
        <p></p>
        <span> 日期:</span>
        <span class="trip_date" id="group_start_date"></span>
        <span class="trip_date" id="group_end_date"></span>
      </div>
      <div class="column is-1">
        <span class="icon_setting" id="group_setting"
          ><i class="fa-solid fa-gear"></i
        ></span>
      </div>
    </div>

    <!--討論區-->
    <div class="columns">
      <div class="column is-1"></div>
      <div class="column is-9 content has-text" style="margin-bottom: 12px">
        <h2>討論區</h2>
      </div>
      <button
        class="button is-2 is-primary"
        id="invite_fd"
        style="border-radius: 10px; margin-top: 10px"
      >
        邀請朋友
      </button>
    </div>

    <div class="columns" style="height: 350px">
      <div class="column is-1"></div>
      <div class="column is-9 content_area content">
        <section
          class="section content_section"
          style="border-radius: 10px; padding: 20px"
        >
          <!--單一留言-->
          <!-- <article class="message is-primary">
            <div
              class="columns group_message message-body"
              style="position: relative"
            >
              <button
                class="delete_content_btn"
                style="position: absolute; top: 5px; right: 15px"
              >
                x
              </button>
              <img
                src="./test.png"
                class="column is-1 group_main_img_content"
              />
              <div class="column is-9">
                <span class="group_main_member_content_name">會員名稱</span
                ><br />
                <span>內容內容</span>
              </div>
              <div class="column is-2 content_time">
                <span class="group_main_msg_time">2023-1-26</span>
                <p></p>
                <span class="group_main_msg_time">16:08:08</span>
              </div>
            </div>
          </article> -->
        </section>
      </div>
      <div class="column is-1 group_member">
        <div class="columns" style="height: 300px">
          <div class="column group_member_list">
            <div
              class="field group_main_member_list_title"
              style="justify-content: center"
            >
              <label>成員列表</label>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="columns">
      <div class="column is-1"></div>
      <div class="field column is-9">
        <label class="label">留言</label>
        <div class="control">
          <input
            class="input"
            id="new_content_input"
            type="text"
            placeholder="請輸入想說的話"
          />
        </div>
        <button name="" id="new_content_btn">提交</button>
      </div>
    </div>

    <!-- 頁尾 -->
    <footer-component></footer-component>
    <script>
      window.addEventListener("load", function () {
        let invite_fd_el = document.getElementById("invite_fd");
        let group_mem_total;
        let member_limit;
        //提交內容
        $("#new_content_btn").click(function () {
          var value = $("#new_content_input").val();
          value = $.trim(value);
          if (value == "") {
            alert("請輸入內容");
          } else {
            // alert($("#new_content_input").val());
            //新增
            var myHeaders = new Headers();
            myHeaders.append(
              "Content-Type",
              "application/x-www-form-urlencoded"
            );
            myHeaders.append(
              "Cookie",
              "JSESSIONID=65AEB3628907BAC51411185C78D24BC4"
            );

            var urlencoded = new URLSearchParams();
            urlencoded.append("action", "addContent");
            urlencoded.append("content", value);
            urlencoded.append("groupid", gpid);

            var requestOptions = {
              method: "POST",
              headers: myHeaders,
              body: urlencoded,
              redirect: "follow",
            };

            fetch("http://localhost:8080/lazy-trip-back/group", requestOptions)
              .then((response) => response.text())
              .then((result) => {
                //重整留言內容
                $(".content_section").html("");
                showContents();
                //重整輸入框
                $("#new_content_input").val("");
              })
              .catch((error) => console.log("error", error));
          }
        });
        //綁定enter提交
        $("#new_content_input").keyup(function (event) {
          if (event.which === 13) {
            $("#new_content_btn").click();
          }
        });

        //fetch獲取群組資訊
        let getUrlString = location.href;
        var url = new URL(getUrlString);
        let gpid = url.searchParams.get("groupid"); // 回傳 groupid
        let user_id;
        // console.log("gpid=" + gpid);

        var myHeaders = new Headers();
        myHeaders.append("Content-Type", "application/x-www-form-urlencoded");
        myHeaders.append(
          "Cookie",
          "JSESSIONID=079AEC6D76AA16D5891CFD9E68BAAFDB"
        );

        var urlencoded = new URLSearchParams();
        urlencoded.append("groupid", gpid);

        // var requestOptions = {
        //   method: "GET",
        //   headers: myHeaders,
        //   body: urlencoded,
        //   redirect: "follow",
        // };
        let url1 =
          "http://localhost:8080/lazy-trip-back/group?action=getOneGroup&groupid=";
        // console.log(url1 + gpid);
        let group_manager_id;
        fetch(url1 + gpid)
          .then((response) => response.json())
          .then((data) => {
            console.log(data);
            $("#gp_main_gpname").html(data[0].groupname);
            group_manager_id = data[0].memberid;
            member_limit = data[0].groupmembercount;
            user_id = data[1].id;
            console.log("管理者為" + group_manager_id);
            console.log("使用者為" + user_id);
            if (data[0].tourid != 0) {
              var requestOptions = {
                method: "GET",
                redirect: "follow",
              };

              fetch(
                "http://localhost:8080/lazy-trip-back/group?action=getTourInfo&tourid=" +
                  data[0].tourid,
                requestOptions
              )
                .then((response) => response.json())
                .then((result) => {
                  console.log(result);
                  $(".trip_name").html(result.tourTitle);
                  $("#group_start_date").html(result.startDate + " ->");
                  $("#group_end_date").html(result.endDate);
                })
                .catch((error) => console.log("error", error));
            }
          })
          .catch((error) => console.log("error", error));

        //點擊設定:
        $("#group_setting").click(function () {
          // console.log(group_manager_id);
          //串上member後使用者的memberid若等於group_manager_id才可以觸發
          if (group_manager_id == user_id) {
            // console.log("gpid" + gpid);
            fetch(url1 + gpid)
              .then((response) => response.json())
              .then((data) => {
                console.log(data);
                $("#gp_main_gpname").html(data.groupname);
                group_manager_id = data.memberid;
                let a1 =
                  "http://localhost:8080/lazy-trip-back/page/group/group_htmls/group_setting.html?groupid=";
                location.href = a1 + data[0].groupid;
              })
              .catch((error) => console.log("error", error));
          } else {
            alert("沒有權限!");
          }
        });

        //載入成員列表

        fetch(
          "http://localhost:8080/lazy-trip-back/group?action=getGroupMems&groupid=" +
            gpid
        )
          .then((response) => response.json())
          .then((data) => {
            console.log(data);
            group_mem_total = data.length;
            console.log("群組共有" + group_mem_total);
            $.each(data, function (index, item) {
              // console.log(item.username);
              var list_html = "";
              var mem_name = "";
              var mem_pic = "";
              var img_src = "";

              if (item.imgBase64Str != null) {
                // console.log("有喔");
                img_src = "data:image/*;base64," + item.imgBase64Str;
              } else {
                img_src = "./test.png";
              }

              if (item.username != null) {
                // console.log(item.username);
                mem_name = item.username;
              } else if (item.name != null) {
                // console.log(item.name);
                mem_name = item.name;
              } else {
                mem_name = "暫無會員名";
              }

              // <label
              //   ><img
              //     class="group_main_img_member_list"
              //     src="./test.png"
              //   />中文中文中文中文</label
              // >
              list_html += '<div class="member_list_content">';
              if (item.id == group_manager_id) {
                list_html +=
                  '<i style="color: yellow;" class="fa-solid fa-crown"></i>';
              }
              list_html += '<label><img class="group_main_img_member_list"';
              list_html += ' src="';
              list_html += img_src;
              list_html += '"/>';
              list_html += mem_name;
              list_html += "</label>";
              list_html += "</div>";

              $(".group_member_list").append(list_html);
            });
          })
          .catch((error) => console.log("error", error));

        //邀請朋友按鍵
        invite_fd_el.onclick = () => {
          if (group_mem_total < member_limit) {
            // alert("OK");
          }
          let show_alert = document.getElementById("group_main_fs_alert");
          show_alert.style.display = "block";
          let close_alert = document.getElementById("alert_ok");
          function close() {
            show_alert.style.display = "none";
          }
          close_alert.addEventListener("click", close);
        };
        let search_fd_el = document.getElementById("search_fd");
        search_fd_el.onclick = () => {
          let search_fd_ct = document.getElementById("fd_id");
          var submit_vl = fd_id.value;
          // console.log(submit_vl);
          var search_rs_txt = document.getElementById("search_rs");
          search_rs_txt.innerText = submit_vl;
          search_rs_txt.style.display = "block";
        };
        search_rs.onclick = () => {
          alert("已發送邀請");
        };

        //顯示群組留言func()
        var showContents = function () {
          fetch(
            "http://localhost:8080/lazy-trip-back/group?action=getGroupCons&groupid=" +
              gpid
          )
            .then((response) => response.json())
            .then((data) => {
              console.log(data);
              $.each(data, function (index, item) {
                var list_html = "";
                var mem_name = "";
                var mem_pic = "";
                var img_src = "";
                var delete_btn_str = "";
                var amend_btn_str = "";
                if (item.member.imgBase64Str != null) {
                  // console.log("有喔");
                  img_src = "data:image/*;base64," + item.member.imgBase64Str;
                } else {
                  img_src = "./test.png";
                }

                //刪除按鈕顯示判斷
                if (item.memberid === user_id || group_manager_id === user_id) {
                  delete_btn_str = "";
                } else {
                  delete_btn_str = " display : none";
                }

                if (item.member.username != null) {
                  // console.log(item.member.username);
                  mem_name = item.member.username;
                } else if (item.member.name != null) {
                  // console.log(item.member.name);
                  mem_name = item.member.name;
                } else {
                  mem_name = "暫無會員名";
                }
                list_html = `<article class="message is-primary">
            <div
              class="columns group_message message-body"
              style="position: relative"
              id="${item.discussion}"
            >

            <span id="span_del${item.discussion}" class="icon_delete" style="position: absolute; top: 5px; right: 15px;cursor: pointer ;${delete_btn_str}"
          ><i class="fa-solid fa-trash-can"></i></span>

              <img
                src="${img_src}"
                class="column is-1 group_main_img_content"
              />
              <div class="column is-9">
                <span class="group_main_member_content_name">${mem_name}</span
                ><br />
                <p id="p${item.discussion}">${item.discussioncontent}</p>
              </div>
              <div class="column is-2 content_time">
                <span class="group_main_msg_time">${item.dicussionday}</span>
                <p></p>
                <span class="group_main_msg_time">${item.dicussiontime}</span>
              </div>
            </div>
          </article>`;
                $(".content_section").append(list_html);
                var span_del = "#span_del" + item.discussion;
                $(span_del).click(function (e) {
                  e.stopPropagation();
                  // console.log("!!");
                  var that = this;
                  console.log($(that).closest("div").attr("id"));
                  var r = confirm("確定要刪除此筆留言嗎?");
                  if (r == true) {
                    //放入fetch delete 以及alert放在成功後
                    var myHeaders = new Headers();
                    myHeaders.append(
                      "Content-Type",
                      "application/x-www-form-urlencoded"
                    );
                    myHeaders.append(
                      "Cookie",
                      "JSESSIONID=65AEB3628907BAC51411185C78D24BC4"
                    );

                    var urlencoded = new URLSearchParams();
                    urlencoded.append("action", "delDiscussion");

                    var requestOptions = {
                      method: "DELETE",
                      headers: myHeaders,
                      body: urlencoded,
                      redirect: "follow",
                    };

                    fetch(
                      "http://localhost:8080/lazy-trip-back/group?action=delDiscussion&discussionId=" +
                        item.discussion,
                      requestOptions
                    )
                      .then((response) => response.text())
                      .then((result) => {
                        alert("刪除成功!");
                        //重整留言內容
                        $(".content_section").html("");
                        showContents();
                      })
                      .catch((error) => console.log("error", error));
                  } else {
                    e.preventDefault();
                  }
                });
              });
            })
            .catch((error) => console.log("error", error));
        };
        //首次載入時顯示內容
        showContents();
      });
    </script>
  </body>
</html>
