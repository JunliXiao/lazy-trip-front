<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sign In</title>
    <!-- Bulma 自訂 -->
    <link rel="stylesheet" href="../../asset/css/my-bulma.css" />
    <!-- 自定義 CSS -->
    <link rel="stylesheet" href="../../asset/css/index-style.css" />
    <!-- Font Awesome -->
    <script
      src="https://kit.fontawesome.com/0548105e54.js"
      crossorigin="anonymous"
    ></script>
    <!-- jquery -->
    <script src="../../asset/js/jquery-3.6.3.min.js"></script>
    <!-- cropper -->
    <link rel="stylesheet" href="../../asset/css/croppie.css" />
    <script src="../../asset/js/croppie.min.js"></script>
    <!-- 共用元件 -->
    <script
      defer
      src="../../asset/js/components.js?ver=2"
      type="text/javascript"
    ></script>
    <script defer src="js/mem_component.js" type="text/javascript"></script>
    <!-- 初始化 Bulma -->
    <script defer src="../../asset/js/bulma-init.js?ver=2"></script>
    <style>
      div.mem_img > img {
        border-radius: 100%;
        width: 100px;
        height: 100px;
      }
      div.upload_img > img {
        border-radius: 100%;
        width: 100px;
        height: 100px;
      }
      span.mem_acc {
        text-align: start;
      }
      span.gear {
        border: 1px solid black;
      }
      div.upload_img > a > img {
        border-radius: 100%;
        width: 100px;
        height: 100px;
      }
      div.img_test {
        top: 40px;
        /* color: white; */

        position: absolute;
        z-index: 5;
      }
      div.upload_img {
        width: 100px;
      }
    </style>
  </head>
  <body>
    <header-component></header-component>

    <!-- 網頁主體 -->
    <section class="section mt-6">
      <div class="container mb-3 is-max-widescreen">
        <div class="tile is-ancestor">
          <div class="tile is-parent box is-12">
            <div class="tile is-child is-5">
              <nav class="level">
                <div class="level-left">
                  <div class="level-item has-text-centered">
                    <div class="mem_img ml-4">
                      <img src="../../asset/img/default.png" alt="" />
                    </div>
                  </div>
                  <div class="level-item has-text-centered">
                    <span class="mem_username mb-6 is-size-3">AAA</span>
                  </div>
                </div>
              </nav>

              <div class="tabs is-medium mt-4">
                <ul>
                  <li class="is-active">
                    <a class="tabs" data-id="dynamic_msg">動態消息</a>
                  </li>
                  <li><a class="tabs" data-id="comment">評論</a></li>
                  <li><a class="tabs" data-id="img">相片</a></li>
                  <li><a class="tabs" data-id="tour">旅程</a></li>
                </ul>
              </div>
            </div>
            <div class="tile is-child"></div>
            <div class="tile is-child is-2">
              <button
                class="button js-modal-trigger mt-3"
                data-target="modal-self-edit"
              >
                <span class="icon">
                  <i class="fa-solid fa-gear"></i>
                </span>
                <span>編輯個人資料</span>
              </button>
            </div>
          </div>
        </div>
      </div>

      <div class="columns">
        <div class="column is-one-quarter">
          <div class="card mb-3">
            <div class="card-content ml-4">
              <div class="content intro">
                <div class="">簡介</div>
              </div>
              <button
                class="button js-modal-trigger"
                data-target="modal-self-intro"
              >
                <span class="icon">
                  <i class="fa-solid fa-gear"></i>
                </span>
                <span>編輯簡介</span>
              </button>
            </div>
          </div>
          <div class="card mb-3">
            <div class="card-content">
              <div class="content ml-4">
                <button class="button">
                  <span class="icon">
                    <i class="fa-solid fa-image"></i>
                  </span>
                  <span>分享圖片</span>
                </button>
              </div>
              <div class="content ml-4">
                <button class="button">
                  <span class="icon">
                    <i class="fa-solid fa-pen-to-square"></i>
                  </span>
                  <span>撰寫評論</span>
                </button>
              </div>
            </div>
          </div>
        </div>

        <div class="column is-7">
          <div id="dynamic_msg" class="content-tab">
            <card-component></card-component>
          </div>
          <div id="comment" class="content-tab" style="display: none">
            <card-component></card-component>
            <card-component></card-component>
          </div>
          <div id="img" class="content-tab" style="display: none">
            <card-component></card-component>
          </div>
          <div id="tour" class="content-tab" style="display: none">
            <card-component></card-component>
          </div>
        </div>
      </div>
    </section>

    <!-- 編輯個人資料 -->
    <div id="modal-self-edit" class="modal">
      <div class="modal-background"></div>
      <div class="modal-card">
        <header class="modal-card-head">
          <p class="modal-card-title">編輯個人資料</p>
          <button class="delete" aria-label="close"></button>
        </header>
        <section class="modal-card-body">
          <div class="field">
            <label class="label" for="input-name">姓名</label>
            <div class="control">
              <input
                class="input"
                type="text"
                name="name"
                placeholder=""
                id="input-name"
              />
            </div>
          </div>

          <div class="field">
            <label class="label" for="input-phone">電話</label>
            <div class="control">
              <input
                class="input"
                type="number"
                name="phone"
                placeholder="0912345678"
                id="input-phone"
              />
            </div>
          </div>
          <div class="field">
            <label class="label" for="input-address">住址</label>
            <div class="control">
              <input
                class="input"
                type="text"
                name="address"
                placeholder="OO市XX區YY路N巷M號"
                id="input-address"
              />
            </div>
          </div>

          <div class="field username">
            <label class="label" for="input-username">暱稱</label>
            <div class="control">
              <input
                class="input"
                type="text"
                name="username"
                placeholder="暱稱"
                id="input-username"
              />
            </div>
          </div>

          <div class="field gender">
            <label class="label" for="input-gender">性別</label>
            <div class="control">
              <label><input type="radio" name="gender" value="男" />男</label>
              <label><input type="radio" name="gender" value="女" />女</label>
              <label
                ><input type="radio" name="gender" value="其他" />其他</label
              >
            </div>
          </div>

          <div class="field birthday">
            <label class="label" for="input-birthday">生日</label>
            <div class="control">
              <input
                class="input"
                type="date"
                name="birthday"
                id="input-birthday"
                min="1900-01-01"
              />
            </div>
          </div>

          <!-- Content ... -->
        </section>
        <footer class="modal-card-foot">
          <button class="button is-success btn_edit">保存</button>
          <button class="button">取消</button>
        </footer>
      </div>
    </div>

    <!-- 編輯簡介 modal -->
    <div id="modal-self-intro" class="modal">
      <div class="modal-background"></div>
      <div class="modal-card">
        <header class="modal-card-head">
          <p class="modal-card-title">編輯簡介</p>
          <button class="delete" aria-label="close"></button>
        </header>
        <section class="modal-card-body">
          <div class="field">
            <div class="control">
              <div class="mem_img_upload">
                <div class="upload_img">
                  <a
                    class="js-modal-trigger"
                    role="button"
                    data-target="modal-self-img"
                    ><img src="../../asset/img/default.png" alt="" />
                    <div class="img_test">上傳個人圖片</div></a
                  >
                </div>
              </div>
            </div>
          </div>

          <div class="field">
            <label class="label" for="input-address">住址</label>
            <div class="control">
              <input
                class="input"
                type="text"
                name="address"
                placeholder="OO市XX區YY路N巷M號"
                id="input-address"
              />
            </div>
          </div>

          <div class="field username">
            <label class="label" for="input-username">暱稱</label>
            <div class="control">
              <input
                class="input"
                type="text"
                name="username"
                placeholder="暱稱"
                id="input-username"
              />
            </div>
          </div>

          <div class="field intro">
            <label class="label" for="input-intro">個人簡介</label>
            <textarea
              class="textarea is-medium"
              placeholder="Medium size textarea field"
              id="input-intro"
            >
            </textarea>
          </div>
        </section>
        <footer class="modal-card-foot">
          <button class="button is-success btn_intro">保存</button>
          <button class="button">取消</button>
        </footer>
      </div>
    </div>

    <!-- 上傳個人圖片 modal -->
    <div id="modal-self-img" class="modal">
      <div class="modal-background"></div>
      <div class="modal-card">
        <header class="modal-card-head">
          <p class="modal-card-title">上傳圖片</p>
          <button class="delete" aria-label="close"></button>
        </header>
        <section class="modal-card-body">
          <div class="field">
            <div class="control">
              <label class="button"
                ><input
                  id="upload_img"
                  style="display: none"
                  type="file"
                  accept="image/*"
                /><i class="fa fa-photo"></i> 上傳圖片</label
              >

              <div id="oldImg" style="display: none"></div>

              <button id="crop_img" class="button">
                <i class="fa fa-scissors"></i> 裁剪圖片
              </button>

              <div id="newImgInfo"></div>
              <div id="newImg"></div>
            </div>
          </div>
        </section>
        <footer class="modal-card-foot">
          <button class="button is-success btn_upload_avatar">保存</button>
          <button class="button">取消</button>
        </footer>
      </div>
    </div>

    <footer-component></footer-component>

    <script>
      $(function () {
        const mem_username = $("span.mem_username");
        const img = $("div.mem_img");
        const img_upload = $("div.mem_img_upload > div > a");
        const fig_img = $("figure.image.is-48x48 ");

        const name = $("input#input-name");
        const phone = $("input#input-phone");
        const address = $("input#input-address");
        const username = $("input#input-username");
        const birth = document.getElementById("input-birthday");
        const intro = $("input#input-intro");

        birth.max = new Date(
          new Date().getTime() - new Date().getTimezoneOffset() * 60000
        )
          .toISOString()
          .split("T")[0];
        // ------------------------------

        function getCookie(name) {
          const value = `; ${document.cookie}`;
          const parts = value.split(`; ${name}=`);
          if (parts.length === 2) return parts.pop().split(";").shift();
        }

        // ---------------------------------

        $(document).on("click", "a.tabs", function () {
          let tab_id = $(this).attr("data-id");
          let tab_content = document.getElementsByClassName("content-tab");

          $(this).closest("ul").find("li").removeClass("is-active");
          $(this).closest("li").addClass("is-active");
          for (let i = 0; i < tab_content.length; i++) {
            tab_content[i].style.display = "none";
          }
          document.getElementById(tab_id).style.display = "block";
        });

        $("button.btn_edit").on("click", function () {
          let gender = $("input[type=radio][name=gender]:checked");

          fetch("save", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              id: parseInt(getCookie("memId")),
              name: name.val().trim(),
              phone: phone.val().trim(),
              address: address.val().trim(),
              username: username.val().trim(),
              gender: gender.val(),
              birthday: birth.value,
            }),
          })
            .then((resp) => resp.json())
            .then((body) => {
              alert(`successful: ${body.successful} message: ${body.message}`);
              if (body.successful == true) {
                location.assign("main.html");
              }
            });
        });

        $("button.btn_intro").on("click", function () {
          fetch("upload", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              id: parseInt(getCookie("memId")),
              name: name.val(),
              phone: phone.val(),
              address: address.val(),
              username: username.val(),
              gender: gender.val(),
              birthday: birth.value,
            }),
          })
            .then((resp) => resp.json())
            .then((body) => {
              alert(`successful: ${body.successful} message: ${body.message}`);
              if (body.successful == true) {
                location.assign("main.html");
              }
            });
        });

        $("button.btn_upload_avatar").on("click", function () {
          let base64 = $("#update_avatar").attr("src").split(",")[1];
          fetch("upload", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              id: getCookie("memId"),
              imgBase64Str: base64,
            }),
          }).then((resp) => {
            if (resp.ok) {
              getData();
            }
          });
        });
        function getData() {
          fetch(`find?id=${getCookie("memId")}`)
            .then((resp) => resp.json())
            .then((member) => {
              let mem_img;
              if (member.hasOwnProperty("imgBase64Str")) {
                mem_img = `<img src="data:image/*;base64,${member.imgBase64Str}" alt="Placeholder image"
            class="is-rounded">`;
                mem_img_upload = `
              <img src="data:image/*;base64,${member.imgBase64Str}" alt="Placeholder image"
            class="is-rounded">
                    <div class="img_test">上傳個人圖片</div>`;
              } else {
                mem_img = `<img src="../../asset/img/default.png" alt="Placeholder image"
            class="is-rounded">`;
                mem_img_upload = `
             <img src="../../asset/img/default.png" alt="Placeholder image"
            class="is-rounded">
                    <div class="img_test">上傳個人圖片</div>`;
              }
              img.empty();
              fig_img.empty();
              img_upload.empty();
              img.prepend(mem_img);
              fig_img.prepend(mem_img);
              img_upload.prepend(mem_img_upload);
              mem_username.text(member.username);

              $("input[name=gender][value=" + member.gender + "]").prop(
                "checked",
                true
              );
              name.val(member.name);
              phone.val(member.phone);
              address.val(member.address);
              username.val(member.username);
              birth.value = `${member.birthday}`;
              intro.val(member.intro);
            });
        }
        getData();

        // image upload
        (function ($) {
          var width_crop = 300, // 圖片裁切寬度 px 值
            height_crop = 300, // 圖片裁切高度 px 值
            type_crop = "circle", // 裁切形狀: square 為方形, circle 為圓形
            width_preview = 350, // 預覽區塊寬度 px 值
            height_preview = 350, // 預覽區塊高度 px 值
            compress_ratio = 0.85, // 圖片壓縮比例 0~1
            type_img = "jpeg", // 圖檔格式 jpeg png webp
            oldImg = new Image(),
            myCrop,
            file,
            oldImgDataUrl;

          // 裁切初始參數設定
          myCrop = $("#oldImg").croppie({
            viewport: {
              // 裁切區塊
              width: width_crop,
              height: height_crop,
              type: type_crop,
            },
            boundary: {
              // 預覽區塊
              width: width_preview,
              height: height_preview,
            },
          });

          function readFile(input) {
            if (input.files && input.files[0]) {
              file = input.files[0];
            } else {
              alert("瀏覽器不支援此功能！建議使用最新版本 Chrome");
              return;
            }

            if (file.type.indexOf("image") == 0) {
              var reader = new FileReader();

              reader.onload = function (e) {
                oldImgDataUrl = e.target.result;
                oldImg.src = oldImgDataUrl; // 載入 oldImg 取得圖片資訊
                myCrop.croppie("bind", {
                  url: oldImgDataUrl,
                });
              };

              reader.readAsDataURL(file);
            } else {
              alert("您上傳的不是圖檔！");
            }
          }

          function displayCropImg(src) {
            var html = "<img src='" + src + "' id='update_avatar'/>";
            $("#newImg").html(html);
          }

          $("#upload_img").on("change", function () {
            $("#oldImg").show();
            readFile(this);
          });

          oldImg.onload = function () {
            var width = this.width,
              height = this.height,
              fileSize = Math.round(file.size / 1000),
              html = "";

            html += "<p>原始圖片尺寸 " + width + "x" + height + "</p>";
            html += "<p>檔案大小約 " + fileSize + "k</p>";
            $("#oldImg").before(html);
          };

          function displayNewImgInfo(src) {
            var html = "",
              filesize = src.length * 0.75;

            html +=
              "<p>裁切圖片尺寸 " + width_crop + "x" + height_crop + "</p>";
            html += "<p>檔案大小約 " + Math.round(filesize / 1000) + "k</p>";
            $("#newImgInfo").html(html);
          }

          $("#crop_img").on("click", function () {
            myCrop
              .croppie("result", {
                type: "canvas",
                size: { width: 100, heiht: 100, type: "circle" },
                format: "canvas",
                quality: compress_ratio,
              })
              .then(function (src) {
                displayCropImg(src);
                displayNewImgInfo(src);
              });
          });
        })(jQuery);
      });
    </script>
  </body>
</html>
